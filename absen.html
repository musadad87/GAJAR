<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Guru Pro Mobile (Sync)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; font-size: 10pt; padding-bottom: 0; }
            .print-container { padding: 0; margin: 0; width: 100%; box-shadow: none; }
            table { width: 100%; border-collapse: collapse; page-break-inside: auto; }
            tr { page-break-inside: avoid; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; }
            @page { size: A4 landscape; margin: 5mm; }
        }

        .editable:focus { background-color: #e0f2fe; outline: none; }
        .overflow-x-auto::-webkit-scrollbar { height: 4px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        @media (max-width: 640px) {
            .container-custom { padding: 10px; width: 100%; margin-top: 0; border-radius: 0; box-shadow: none; }
            input, select, button { font-size: 14px; }
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #0f172a; color: white;
            display: flex; justify-content: space-around;
            padding: 10px 0; z-index: 50;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 10px; opacity: 0.6; transition: 0.3s;
            background: none; border: none; color: white;
        }
        .nav-item.active { opacity: 1; color: #fbbf24; transform: scale(1.1); }
        .nav-item i { font-size: 18px; margin-bottom: 2px; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        #sync-badge {
            font-size: 10px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: #475569; cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-lg font-bold text-gray-700">Menghubungkan...</h2>
        <p class="text-sm text-gray-500">Mencari Kode Sinkronisasi</p>
    </div>

    <!-- TOP BAR -->
    <div class="bg-white p-3 shadow-sm sticky top-0 z-40 flex flex-col gap-2 no-print">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center gap-2 flex-1">
                <div class="bg-slate-100 rounded p-1 px-2 flex-1 flex items-center border">
                    <i class="fas fa-users text-slate-500 text-xs mr-2"></i>
                    <select id="class-selector" onchange="changeClass(this.value)" class="bg-transparent font-bold text-sm w-full outline-none text-slate-800">
                        <!-- Options JS -->
                    </select>
                </div>
                <button onclick="addNewClass()" class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center shadow">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            </div>
            <div class="flex flex-col items-end ml-2">
                <div id="save-status" class="text-[10px] font-bold text-gray-400 px-2 mb-1">
                    <span class="status-dot bg-gray-300"></span>...
                </div>
            </div>
        </div>
        <!-- Sync Info Bar -->
        <div class="flex justify-between items-center bg-slate-50 px-2 py-1 rounded border border-slate-200">
            <div class="text-[10px] text-slate-500">
                <i class="fas fa-link mr-1"></i>Kode Sync: <span id="current-school-code" class="font-bold text-blue-600">...</span>
            </div>
            <button onclick="changeSchoolCode()" class="text-[10px] text-blue-500 underline">Ganti Kode</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-5xl mx-auto bg-white min-h-screen container-custom print-container">

        <!-- KOP LAPORAN -->
        <div class="hidden md:grid grid-cols-2 gap-8 mb-6 border-b-2 border-black pb-4 pt-4">
            <div>
                <h2 class="text-xl font-bold uppercase" id="disp-school">SEKOLAH</h2>
                <div class="text-sm mt-1">
                    <p>Mapel: <span id="disp-mapel" class="font-bold">-</span></p>
                    <p>Kelas: <span id="disp-kelas" class="font-bold">-</span></p>
                </div>
            </div>
            <div class="text-right text-sm">
                <p>Semester: <span id="disp-semester">-</span></p>
                <p>Guru: <span id="disp-guru">-</span></p>
            </div>
        </div>

        <!-- TAB 1: DATA SISWA -->
        <div id="tab-data" class="block pb-20">
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4 no-print">
                <h3 class="text-sm font-bold text-blue-800 mb-2"><i class="fas fa-cog mr-1"></i> Identitas Kelas</h3>
                <div class="grid grid-cols-1 gap-2 text-sm">
                    <input type="text" id="in-classname" oninput="debouncedUpdateInfo()" class="border p-2 rounded w-full" placeholder="Nama Kelas (X TKJ 1)">
                    <input type="text" id="in-mapel" oninput="debouncedUpdateInfo()" class="border p-2 rounded w-full" placeholder="Mata Pelajaran">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="in-semester" oninput="debouncedUpdateInfo()" class="border p-2 rounded w-full" placeholder="Semester">
                        <input type="text" id="in-guru" oninput="debouncedUpdateInfo()" class="border p-2 rounded w-full" placeholder="Nama Guru">
                    </div>
                     <input type="text" id="in-school" oninput="debouncedUpdateInfo()" class="border p-2 rounded w-full" placeholder="Nama Sekolah">
                </div>
            </div>

            <div class="flex justify-between items-center mb-2 no-print">
                <h3 class="font-bold text-gray-700">Siswa</h3>
                <div class="flex gap-2">
                    <label class="bg-green-600 text-white px-3 py-1 rounded text-xs flex items-center shadow cursor-pointer">
                        <i class="fas fa-file-excel mr-1"></i> Import
                        <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(this)">
                    </label>
                    <button onclick="addStudent()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs shadow">
                        <i class="fas fa-user-plus mr-1"></i> Tambah
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto bg-white border rounded shadow-sm">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                        <tr>
                            <th class="p-2 w-8 text-center">No</th>
                            <th class="p-2 min-w-[150px]">Nama Siswa</th>
                            <th class="p-2 w-16 text-center">L/P</th>
                            <th class="p-2 w-10 text-center no-print"><i class="fas fa-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body" class="divide-y"></tbody>
                </table>
            </div>
            
            <div class="mt-8 no-print flex gap-2 justify-center">
                 <button onclick="exportToExcel()" class="bg-gray-600 text-white px-4 py-2 rounded text-xs shadow"><i class="fas fa-download mr-1"></i> Backup Excel</button>
                 <button onclick="deleteCurrentClass()" class="bg-red-100 text-red-600 px-4 py-2 rounded text-xs"><i class="fas fa-trash mr-1"></i> Hapus Kelas</button>
            </div>
        </div>

        <!-- TAB 2: ABSENSI -->
        <div id="tab-absensi" class="hidden pb-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Absensi</h3>
                <div class="text-xs text-gray-500">Klik tanggal untuk ubah</div>
            </div>
            
            <div class="overflow-x-auto border rounded shadow-sm">
                <table class="w-full border-collapse text-xs">
                    <thead>
                        <tr class="bg-slate-100">
                            <th rowspan="2" class="border p-1 sticky left-0 bg-slate-100 z-10 w-8">No</th>
                            <th rowspan="2" class="border p-1 sticky left-8 bg-slate-100 z-10 min-w-[120px] text-left">Nama</th>
                            <th colspan="30" class="border p-1 text-center">Pertemuan</th>
                            <th colspan="4" class="border p-1">Total</th>
                        </tr>
                        <tr class="bg-slate-50 text-[10px] text-center">
                            <script>for(let i=1; i<=30; i++) document.write(`<th class="border p-1 min-w-[20px]">${i}</th>`);</script>
                            <th class="border p-1 bg-yellow-100">S</th>
                            <th class="border p-1 bg-blue-100">I</th>
                            <th class="border p-1 bg-red-100">A</th>
                            <th class="border p-1 bg-purple-100">B</th>
                        </tr>
                    </thead>
                    <tbody id="absensi-body"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: NILAI -->
        <div id="tab-nilai" class="hidden pb-20">
            <h3 class="font-bold text-lg mb-4">Input Nilai</h3>
            <div class="overflow-x-auto border rounded shadow-sm">
                <table class="w-full border-collapse text-xs">
                    <thead>
                        <tr class="bg-slate-100">
                            <th rowspan="2" class="border p-1 sticky left-0 bg-slate-100 z-10 w-8">No</th>
                            <th rowspan="2" class="border p-1 sticky left-8 bg-slate-100 z-10 min-w-[120px] text-left">Nama</th>
                            <th colspan="4" class="border p-1">Harian (LM)</th>
                            <th rowspan="2" class="border p-1 bg-gray-50 w-10">Rata</th>
                            <th rowspan="2" class="border p-1 w-10">STS</th>
                            <th rowspan="2" class="border p-1 w-10">SAS</th>
                            <th rowspan="2" class="border p-1 bg-blue-50 font-bold w-10">NA</th>
                            <th rowspan="2" class="border p-1 min-w-[80px]">Pred</th>
                        </tr>
                        <tr class="bg-slate-50 text-[10px]">
                            <th class="border p-1 w-8">1</th>
                            <th class="border p-1 w-8">2</th>
                            <th class="border p-1 w-8">3</th>
                            <th class="border p-1 w-8">4</th>
                        </tr>
                    </thead>
                    <tbody id="nilai-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav no-print">
        <button onclick="switchTab('data')" id="nav-data" class="nav-item active">
            <i class="fas fa-user-graduate"></i>
            <span>Data</span>
        </button>
        <button onclick="switchTab('absensi')" id="nav-absensi" class="nav-item">
            <i class="fas fa-calendar-check"></i>
            <span>Absen</span>
        </button>
        <button onclick="switchTab('nilai')" id="nav-nilai" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Nilai</span>
        </button>
        <button onclick="window.print()" class="nav-item">
            <i class="fas fa-print"></i>
            <span>PDF</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG (Milik User)
        const firebaseConfig = {
            apiKey: "AIzaSyAXOHHI9ytfcjK1sc4ZoErSheJ3zPyM3u4",
            authDomain: "x-casing-482715-v7.firebaseapp.com",
            projectId: "x-casing-482715-v7",
            storageBucket: "x-casing-482715-v7.firebasestorage.app",
            messagingSenderId: "752575391484",
            appId: "1:752575391484:web:15111344c032cd6ad4d979",
            measurementId: "G-VP8Q3DSHMD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let schoolCode = localStorage.getItem('gurupro_school_code');
        window.appState = { classes: [], activeClassId: null };

        // INITIALIZE
        async function initApp() {
            if(!schoolCode) {
                showLoading(false);
                const { value: code } = await Swal.fire({
                    title: 'Sinkronisasi Perangkat',
                    text: 'Buat/Masukkan Kode Unik agar data terhubung di semua perangkat (Misal: smk123)',
                    input: 'text',
                    inputPlaceholder: 'Kode Unik (Wajib Sama di HP & Laptop)',
                    allowOutsideClick: false,
                    inputValidator: (value) => { return !value && 'Kode tidak boleh kosong!' }
                });
                if(code) {
                    schoolCode = code.trim();
                    localStorage.setItem('gurupro_school_code', schoolCode);
                }
            }
            
            document.getElementById('current-school-code').innerText = schoolCode;
            showLoading(true);
            
            // Login Anonim (Hanya untuk akses Firebase)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await fetchClasses();
                } else {
                    signInAnonymously(auth).catch(e => Swal.fire("Error Auth", e.message, "error"));
                }
            });
        }

        // DATABASE LOGIC (USING SCHOOL CODE, NOT UID)
        async function fetchClasses() {
            try {
                // PATH DIUBAH: schools/{schoolCode}/classes
                const q = collection(db, 'schools', schoolCode, 'classes');
                const querySnapshot = await getDocs(q);
                window.appState.classes = [];
                querySnapshot.forEach((doc) => window.appState.classes.push(doc.data()));

                if(window.appState.classes.length === 0) await createDefaultClass();
                else if(!window.appState.activeClassId) window.appState.activeClassId = window.appState.classes[0].id;

                renderClassSelector();
                renderAll();
                updateOnlineStatus(true);
            } catch (e) {
                console.error(e);
                updateOnlineStatus(false);
                Swal.fire("Koneksi", "Gagal mengambil data. Pastikan internet lancar.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function createDefaultClass() {
            const defClass = {
                id: 'cls_' + Date.now(),
                name: "Kelas Percobaan",
                info: { school: "NAMA SEKOLAH", mapel: "Mapel", guru: "Nama Guru", semester: "Ganjil" },
                students: [{ id: 1, nis: "123", name: "Siswa 1", gender: "L", absensi: Array(30).fill(""), nilai: {lm1:0,lm2:0,lm3:0,lm4:0,sts:0,sas:0} }]
            };
            await saveClassToFirestore(defClass);
            window.appState.classes.push(defClass);
            window.appState.activeClassId = defClass.id;
        }

        async function saveClassToFirestore(classObj) {
            updateOnlineStatus(false);
            try {
                // PATH DIUBAH: schools/{schoolCode}/classes
                await setDoc(doc(db, 'schools', schoolCode, 'classes', classObj.id), JSON.parse(JSON.stringify(classObj)));
                updateOnlineStatus(true);
            } catch (e) {
                console.error(e);
                document.getElementById('save-status').innerHTML = '<span class="status-dot bg-red-500"></span>Error Save';
            }
        }

        async function deleteClassFromFirestore(classId) {
            await deleteDoc(doc(db, 'schools', schoolCode, 'classes', classId));
        }

        // GLOBAL HELPERS
        window.changeSchoolCode = () => {
            localStorage.removeItem('gurupro_school_code');
            location.reload();
        }

        window.getActiveClass = () => window.appState.classes.find(c => c.id === window.appState.activeClassId);
        window.changeClass = (id) => { window.appState.activeClassId = id; renderAll(); }

        window.addNewClass = async () => {
            const { value: text } = await Swal.fire({ input: 'text', inputPlaceholder: 'Nama Kelas (misal: XI TSM 2)', showCancelButton: true });
            if (text) {
                const newClass = {
                    id: 'cls_' + Date.now(), name: text,
                    info: { ...window.getActiveClass().info }, students: []
                };
                window.appState.classes.push(newClass);
                window.appState.activeClassId = newClass.id;
                await saveClassToFirestore(newClass);
                renderClassSelector(); renderAll();
            }
        }

        window.deleteCurrentClass = () => {
            if(window.appState.classes.length <= 1) return Swal.fire('Gagal', 'Sisakan minimal 1 kelas.', 'error');
            Swal.fire({ title: 'Hapus Kelas?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' })
            .then(async (res) => {
                if(res.isConfirmed) {
                    showLoading(true);
                    await deleteClassFromFirestore(window.appState.activeClassId);
                    window.appState.classes = window.appState.classes.filter(c => c.id !== window.appState.activeClassId);
                    window.appState.activeClassId = window.appState.classes[0].id;
                    renderClassSelector(); renderAll(); showLoading(false);
                }
            });
        }

        let debounceTimer;
        window.debouncedUpdateInfo = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const cls = window.getActiveClass();
                cls.name = document.getElementById('in-classname').value;
                cls.info.school = document.getElementById('in-school').value;
                cls.info.mapel = document.getElementById('in-mapel').value;
                cls.info.guru = document.getElementById('in-guru').value;
                cls.info.semester = document.getElementById('in-semester').value;
                const selector = document.getElementById('class-selector');
                if(selector.selectedIndex >= 0) selector.options[selector.selectedIndex].text = cls.name;
                updatePrintHeaders(cls);
                saveClassToFirestore(cls);
            }, 1000);
        }

        window.addStudent = async () => {
            const cls = window.getActiveClass();
            cls.students.push({
                id: Date.now(), nis: "", name: "Siswa Baru", gender: "",
                absensi: Array(30).fill(""), nilai: {lm1:0,lm2:0,lm3:0,lm4:0,sts:0,sas:0}
            });
            renderAll(); await saveClassToFirestore(cls);
        }

        window.confirmDeleteStudent = (idx) => {
            Swal.fire({ title: 'Hapus?', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya' })
            .then(async (res) => {
                if(res.isConfirmed) {
                    window.getActiveClass().students.splice(idx, 1);
                    renderAll(); await saveClassToFirestore(window.getActiveClass());
                }
            });
        }

        let saveTimer;
        const debouncedSave = (cls) => {
            document.getElementById('save-status').innerHTML = '<span class="status-dot bg-yellow-400"></span>Saving...';
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => saveClassToFirestore(cls), 1500);
        }

        window.updateStudent = (idx, field, val) => {
            const cls = window.getActiveClass();
            cls.students[idx][field] = val;
            debouncedSave(cls);
        }

        window.updateNilai = (idx, field, val) => {
            const cls = window.getActiveClass();
            cls.students[idx].nilai[field] = val;
            renderNilaiTable(cls); debouncedSave(cls);
        }

        window.cycleAbsensi = (sIdx, dIdx) => {
            const cls = window.getActiveClass();
            const cycles = ["", "S", "I", "A", "B"];
            const curr = cls.students[sIdx].absensi[dIdx] || "";
            cls.students[sIdx].absensi[dIdx] = cycles[(cycles.indexOf(curr)+1)%cycles.length];
            renderAbsensiTable(cls); saveClassToFirestore(cls);
        }

        window.exportToExcel = () => {
            const cls = window.getActiveClass();
            const data = cls.students.map((s,i) => ({ No:i+1, NIS:s.nis, Nama:s.name, Gender:s.gender, Nilai_Akhir: calculateNA(s.nilai).NA }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `Data_${cls.name}.xlsx`);
        }

        window.importFromExcel = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                const cls = window.getActiveClass();
                let count = 0;
                rows.slice(1).forEach(r => {
                    if(r[2]) {
                        cls.students.push({
                            id: Date.now()+count, nis: (r[1]||"").toString(), name: r[2].toString(), gender: (r[3]||"L").toString(),
                            absensi: Array(30).fill(""), nilai: {lm1:0,lm2:0,lm3:0,lm4:0,sts:0,sas:0}
                        });
                        count++;
                    }
                });
                renderAll(); await saveClassToFirestore(cls);
                Swal.fire('Sukses', `${count} siswa masuk.`, 'success');
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // RENDERERS
        window.renderAll = () => {
            const cls = window.getActiveClass();
            if(!cls) return;
            
            if(document.activeElement.tagName !== 'INPUT') {
                document.getElementById('in-classname').value = cls.name;
                document.getElementById('in-school').value = cls.info.school;
                document.getElementById('in-mapel').value = cls.info.mapel;
                document.getElementById('in-guru').value = cls.info.guru;
                document.getElementById('in-semester').value = cls.info.semester;
            }
            updatePrintHeaders(cls);

            let h = '';
            cls.students.forEach((s,i) => {
                h += `<tr class="border-b hover:bg-slate-50">
                    <td class="p-2 text-center">${i+1}</td>
                    <td class="p-2"><input value="${s.name}" oninput="window.updateStudent(${i},'name',this.value)" class="w-full bg-transparent font-medium outline-none">
                        <div class="text-[10px] text-gray-400"><input value="${s.nis}" oninput="window.updateStudent(${i},'nis',this.value)" class="bg-transparent outline-none w-20" placeholder="NIS"></div>
                    </td>
                    <td class="p-2 text-center"><input value="${s.gender}" oninput="window.updateStudent(${i},'gender',this.value)" class="w-8 text-center bg-transparent uppercase outline-none"></td>
                    <td class="p-2 text-center no-print"><button onclick="window.confirmDeleteStudent(${i})" class="text-red-400"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('student-list-body').innerHTML = h || '<tr><td colspan="4" class="p-4 text-center text-gray-400 italic">Belum ada siswa</td></tr>';
            renderAbsensiTable(cls);
            renderNilaiTable(cls);
        }

        function renderAbsensiTable(cls) {
            let h = '';
            cls.students.forEach((s,i) => {
                let c = {S:0, I:0, A:0, B:0};
                s.absensi.forEach(x => {if(c[x]!==undefined)c[x]++});
                h += `<tr><td class="border p-1 text-center bg-slate-50 sticky left-0 z-10">${i+1}</td><td class="border p-1 px-2 whitespace-nowrap sticky left-8 bg-slate-50 z-10">${s.name}</td>`;
                for(let d=0;d<30;d++) {
                    let v = s.absensi[d]||".";
                    let col = v==='S'?'bg-yellow-200':v==='I'?'bg-blue-200':v==='A'?'bg-red-200':v==='B'?'bg-purple-300 font-bold':'';
                    h += `<td onclick="window.cycleAbsensi(${i},${d})" class="border p-0 text-center cursor-pointer select-none ${col}" style="min-width:24px;height:24px">${v}</td>`;
                }
                h += `<td class="border p-1 text-center bg-yellow-50">${c.S||''}</td><td class="border p-1 text-center bg-blue-50">${c.I||''}</td><td class="border p-1 text-center bg-red-50">${c.A||''}</td><td class="border p-1 text-center bg-purple-100">${c.B||''}</td></tr>`;
            });
            document.getElementById('absensi-body').innerHTML = h;
        }

        function renderNilaiTable(cls) {
            let h = '';
            cls.students.forEach((s,i) => {
                const n = s.nilai;
                const {NA, predikat} = calculateNA(n);
                h += `<tr><td class="border p-1 text-center bg-slate-50 sticky left-0 z-10">${i+1}</td><td class="border p-1 px-2 whitespace-nowrap sticky left-8 bg-slate-50 z-10">${s.name}</td>
                <td class="border p-0"><input type="number" value="${n.lm1||''}" oninput="window.updateNilai(${i},'lm1',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-0"><input type="number" value="${n.lm2||''}" oninput="window.updateNilai(${i},'lm2',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-0"><input type="number" value="${n.lm3||''}" oninput="window.updateNilai(${i},'lm3',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-0"><input type="number" value="${n.lm4||''}" oninput="window.updateNilai(${i},'lm4',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-1 text-center bg-gray-50 font-bold">${calculateNA(n).avgLM||''}</td>
                <td class="border p-0"><input type="number" value="${n.sts||''}" oninput="window.updateNilai(${i},'sts',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-0"><input type="number" value="${n.sas||''}" oninput="window.updateNilai(${i},'sas',this.value)" class="w-full text-center p-1 outline-none"></td>
                <td class="border p-1 text-center bg-blue-50 font-bold text-blue-900">${NA||''}</td>
                <td class="border p-1 text-center text-[10px] ${NA<75?'text-red-500':'text-green-600'}">${predikat}</td></tr>`;
            });
            document.getElementById('nilai-body').innerHTML = h;
        }

        window.renderClassSelector = () => {
            const sel = document.getElementById('class-selector');
            sel.innerHTML = '';
            window.appState.classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.text = c.name;
                if(c.id === window.appState.activeClassId) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function calculateNA(n) {
            let s=0, c=0;
            [n.lm1,n.lm2,n.lm3,n.lm4].forEach(v => {if(v>0){s+=parseFloat(v);c++}});
            let avg = c>0 ? s/c : 0;
            let finalS = avg, finalC = 1;
            if(n.sts>0) {finalS+=parseFloat(n.sts); finalC++}
            if(n.sas>0) {finalS+=parseFloat(n.sas); finalC++}
            let NA = avg>0 ? (finalS/finalC).toFixed(0) : 0;
            return { avgLM: avg.toFixed(0), NA: NA, predikat: NA==0?'-':NA>=90?'A':NA>=80?'B':NA>=75?'C':'D' };
        }

        function updatePrintHeaders(cls) {
            document.getElementById('disp-school').innerText = cls.info.school;
            document.getElementById('disp-mapel').innerText = cls.info.mapel;
            document.getElementById('disp-kelas').innerText = cls.name;
            document.getElementById('disp-guru').innerText = cls.info.guru;
            document.getElementById('disp-semester').innerText = cls.info.semester;
        }

        function updateOnlineStatus(online) {
            const el = document.getElementById('save-status');
            el.innerHTML = online ? '<span class="status-dot bg-green-500"></span>Online' : '<span class="status-dot bg-yellow-400"></span>Saving...';
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show?'flex':'none'; }

        window.switchTab = (id) => {
            ['data','absensi','nilai'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active', 'text-yellow-400'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.getElementById('nav-'+id).classList.add('active');
        }

        window.onload = initApp;
    </script>
</body>
</html>
