<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Pro - Terhubung Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; font-size: 10pt; }
            .print-container { padding: 0; margin: 0; width: 100%; box-shadow: none; }
            table { width: 100%; border-collapse: collapse; page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; }
            input { border: none !important; background: transparent; }
            select { appearance: none; border: none; }
            @page { size: A4 landscape; margin: 5mm; }
        }

        .editable:focus { background-color: #e0f2fe; outline: none; }
        .tab-active { background-color: #2563eb; color: white; }
        .tab-inactive { background-color: #1e3a8a; color: gray-300; }
        .tab-inactive:hover { background-color: #1e40af; color: white; }
        
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f1f1; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Loader */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-indicator {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700">Menghubungkan ke Database Anda...</h2>
        <p class="text-gray-500">Project ID: x-casing-482715-v7</p>
    </div>

    <!-- NAVIGATION BAR -->
    <div class="bg-slate-900 text-white p-3 shadow-md no-print sticky top-0 z-50">
        <div class="max-w-[98%] mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            
            <div class="flex items-center gap-4 w-full md:w-auto">
                <h1 class="text-lg font-bold text-yellow-400 hidden md:block"><i class="fas fa-database mr-2"></i>GuruPro Cloud</h1>
                
                <div class="flex items-center bg-slate-800 rounded p-1 border border-slate-600">
                    <span class="text-xs text-gray-400 ml-2 mr-2">KELAS:</span>
                    <select id="class-selector" onchange="changeClass(this.value)" class="bg-slate-900 text-white font-bold text-sm p-1 rounded border-none focus:ring-0 cursor-pointer min-w-[120px]">
                        <!-- Options generated JS -->
                    </select>
                    <button onclick="addNewClass()" class="ml-2 bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs" title="Tambah Kelas Baru">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div id="save-status" class="text-xs text-gray-400 flex items-center gap-1 hidden md:flex">
                    <span class="status-indicator bg-green-500"></span> Online
                </div>
            </div>
            
            <div class="flex space-x-1 bg-slate-800 p-1 rounded-lg overflow-x-auto w-full md:w-auto justify-center">
                <button onclick="switchTab('data')" id="btn-data" class="px-3 py-2 rounded font-medium transition text-sm tab-active whitespace-nowrap">
                    <i class="fas fa-database mr-1"></i> Data Siswa
                </button>
                <button onclick="switchTab('absensi')" id="btn-absensi" class="px-3 py-2 rounded font-medium transition text-sm tab-inactive text-gray-300 whitespace-nowrap">
                    <i class="fas fa-calendar-check mr-1"></i> Absensi
                </button>
                <button onclick="switchTab('nilai')" id="btn-nilai" class="px-3 py-2 rounded font-medium transition text-sm tab-inactive text-gray-300 whitespace-nowrap">
                    <i class="fas fa-chart-bar mr-1"></i> Nilai
                </button>
            </div>

            <div class="flex gap-2">
                 <button onclick="deleteCurrentClass()" class="px-3 py-2 bg-red-700 rounded hover:bg-red-600 text-xs text-white" title="Hapus Kelas Ini">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 font-bold shadow text-sm">
                    <i class="fas fa-print mr-1"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="max-w-[98%] mx-auto mt-4 mb-10 bg-white p-6 rounded-lg shadow-xl min-h-screen print-container">

        <!-- KOP / HEADER LAPORAN -->
        <div class="grid grid-cols-2 gap-8 mb-6 border-b-4 border-double border-black pb-4">
            <div>
                <h2 class="text-2xl font-bold uppercase tracking-wider mb-1" id="disp-school">NAMA SEKOLAH</h2>
                <div class="mt-2 grid grid-cols-[100px_10px_1fr] gap-y-1 text-sm">
                    <span>Mata Pelajaran</span> <span>:</span> <span id="disp-mapel" class="font-bold">-</span>
                    <span>Kelas / Fase</span> <span>:</span> <span id="disp-kelas" class="font-bold bg-yellow-100 px-1">-</span>
                </div>
            </div>
            <div class="text-right flex flex-col justify-end">
                <div class="grid grid-cols-[1fr_10px_150px] gap-y-1 text-sm text-left justify-self-end">
                    <span>Semester / TP</span> <span>:</span> <span id="disp-semester">-</span>
                    <span>Guru Pengampu</span> <span>:</span> <span id="disp-guru">-</span>
                </div>
            </div>
        </div>

        <!-- ================= TAB 1: DATA KELAS (INPUT) ================= -->
        <div id="tab-data" class="block">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 no-print bg-gray-50 p-4 rounded border">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500">Nama Kelas</label>
                    <input type="text" id="in-classname" oninput="debouncedUpdateInfo()" class="w-full border p-2 rounded focus:ring-2 ring-blue-500 bg-white font-bold text-blue-800" placeholder="Contoh: X TKJ 1">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500">Nama Sekolah</label>
                    <input type="text" id="in-school" oninput="debouncedUpdateInfo()" class="w-full border p-2 rounded focus:ring-2 ring-blue-500 bg-white" placeholder="Nama Sekolah">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500">Mata Pelajaran</label>
                    <input type="text" id="in-mapel" oninput="debouncedUpdateInfo()" class="w-full border p-2 rounded focus:ring-2 ring-blue-500 bg-white">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500">Semester / TP</label>
                    <input type="text" id="in-semester" oninput="debouncedUpdateInfo()" class="w-full border p-2 rounded focus:ring-2 ring-blue-500 bg-white" placeholder="Cth: Genap / 2024-2025">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500">Guru Pengampu</label>
                    <input type="text" id="in-guru" oninput="debouncedUpdateInfo()" class="w-full border p-2 rounded focus:ring-2 ring-blue-500 bg-white">
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4 no-print">
                <h3 class="font-bold text-lg border-b-2 border-blue-500">Daftar Siswa</h3>
                
                <div class="flex gap-2">
                    <button onclick="exportToExcel()" class="bg-green-700 text-white px-3 py-2 rounded hover:bg-green-600 text-sm flex items-center shadow">
                        <i class="fas fa-file-excel mr-2"></i> Export
                    </button>
                    
                    <label for="excel-input" class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-500 text-sm flex items-center shadow cursor-pointer">
                        <i class="fas fa-file-import mr-2"></i> Import
                    </label>
                    <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(this)">

                    <button onclick="addStudent()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-500 text-sm flex items-center shadow ml-2">
                        <i class="fas fa-plus mr-2"></i> Manual
                    </button>
                </div>
            </div>
            
            <table class="w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2 w-10">No</th>
                        <th class="border p-2 w-28">NIS</th>
                        <th class="border p-2">Nama Lengkap Siswa</th>
                        <th class="border p-2 w-20 text-center">L/P</th>
                        <th class="border p-2 w-16 text-center no-print">Hapus</th>
                    </tr>
                </thead>
                <tbody id="student-list-body"></tbody>
            </table>
        </div>

        <!-- ================= TAB 2: ABSENSI ================= -->
        <div id="tab-absensi" class="hidden">
            <h2 class="text-center text-xl font-bold mb-4 uppercase underline">Rekap Absensi: <span class="print-class-name"></span></h2>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-black text-sm">
                    <thead>
                        <tr class="bg-gray-200 text-xs">
                            <th rowspan="2" class="border border-black p-1 w-8">No</th>
                            <th rowspan="2" class="border border-black p-1 text-left min-w-[150px] px-2">Nama Siswa</th>
                            <th colspan="30" class="border border-black p-1 text-center">Tanggal / Pertemuan Ke-</th>
                            <th colspan="4" class="border border-black p-1">Total</th>
                        </tr>
                        <tr class="bg-gray-100 text-[9px] text-center">
                            <script>for(let i=1; i<=30; i++) document.write(`<th class="border border-black p-0 w-4">${i}</th>`);</script>
                            <th class="border border-black p-1 bg-yellow-100 w-8 font-bold" title="Sakit">S</th>
                            <th class="border border-black p-1 bg-blue-100 w-8 font-bold" title="Izin">I</th>
                            <th class="border border-black p-1 bg-red-100 w-8 font-bold" title="Alpha">A</th>
                            <th class="border border-black p-1 bg-purple-200 w-8 font-bold" title="Bolos">B</th>
                        </tr>
                    </thead>
                    <tbody id="absensi-body"></tbody>
                </table>
            </div>
            <div class="mt-2 text-xs italic no-print text-gray-600 flex flex-wrap gap-4">
                <span><span class="inline-block w-3 h-3 bg-yellow-200 border border-black"></span> S = Sakit</span>
                <span><span class="inline-block w-3 h-3 bg-blue-200 border border-black"></span> I = Izin</span>
                <span><span class="inline-block w-3 h-3 bg-red-200 border border-black"></span> A = Alpha</span>
                <span><span class="inline-block w-3 h-3 bg-purple-300 border border-black"></span> B = Bolos</span>
            </div>
        </div>

        <!-- ================= TAB 3: NILAI ================= -->
        <div id="tab-nilai" class="hidden">
            <h2 class="text-center text-xl font-bold mb-4 uppercase underline">Daftar Nilai: <span class="print-class-name"></span></h2>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-black text-sm">
                    <thead>
                        <tr class="bg-gray-200 text-xs">
                            <th rowspan="2" class="border border-black p-1 w-8">No</th>
                            <th rowspan="2" class="border border-black p-1 text-left min-w-[200px] px-2">Nama Siswa</th>
                            <th colspan="4" class="border border-black p-1">Nilai Harian (LM)</th>
                            <th rowspan="2" class="border border-black p-1 w-12 bg-gray-50">Rata</th>
                            <th rowspan="2" class="border border-black p-1 w-12">STS</th>
                            <th rowspan="2" class="border border-black p-1 w-12">SAS</th>
                            <th rowspan="2" class="border border-black p-1 w-12 bg-blue-50 font-bold">NA</th>
                            <th rowspan="2" class="border border-black p-1 min-w-[100px]">Predikat</th>
                        </tr>
                        <tr class="bg-gray-100 text-[10px]">
                            <th class="border border-black p-1 w-10">LM1</th>
                            <th class="border border-black p-1 w-10">LM2</th>
                            <th class="border border-black p-1 w-10">LM3</th>
                            <th class="border border-black p-1 w-10">LM4</th>
                        </tr>
                    </thead>
                    <tbody id="nilai-body"></tbody>
                </table>
            </div>

            <div class="mt-12 grid grid-cols-3 gap-8 text-center break-inside-avoid text-sm">
                <div>
                    <p>Mengetahui,</p>
                    <p class="font-bold">Kepala Sekolah</p>
                    <br><br><br>
                    <p class="font-bold underline">_______________________</p>
                </div>
                <div></div>
                <div>
                    <p>Kota Guru, <span id="date-now"></span></p>
                    <p class="font-bold">Guru Pengampu</p>
                    <br><br><br>
                    <p class="font-bold underline" id="sign-guru">-</p>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC (Firebase Module) -->
    <script type="module">
        // Menggunakan library versi 11.6.1 agar kompatibel dengan kode, namun config tetap dari user
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION DARI USER ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXOHHI9ytfcjK1sc4ZoErSheJ3zPyM3u4",
            authDomain: "x-casing-482715-v7.firebaseapp.com",
            projectId: "x-casing-482715-v7",
            storageBucket: "x-casing-482715-v7.firebasestorage.app",
            messagingSenderId: "752575391484",
            appId: "1:752575391484:web:15111344c032cd6ad4d979",
            measurementId: "G-VP8Q3DSHMD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Global
        let currentUser = null;
        window.appState = {
            classes: [],
            activeClassId: null,
            isLoading: false
        };

        // --- 2. AUTHENTICATION (Anonymous Login) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Logged in as:", user.uid);
                currentUser = user;
                await fetchClasses();
            } else {
                currentUser = null;
                // Auto login anonymously
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error:", error);
                    showLoading(false);
                    Swal.fire("Error Koneksi", "Pastikan Anda sudah mengaktifkan 'Anonymous Auth' di Firebase Console.", "error");
                });
            }
        });

        // --- 3. FIRESTORE LOGIC ---
        
        async function fetchClasses() {
            if(!currentUser) return;
            showLoading(true);

            try {
                // Mengambil data dari collection 'classes' milik user ini
                const q = collection(db, 'users', currentUser.uid, 'classes');
                const querySnapshot = await getDocs(q);
                
                window.appState.classes = [];
                querySnapshot.forEach((doc) => {
                    window.appState.classes.push(doc.data());
                });

                if(window.appState.classes.length === 0) {
                    await createDefaultClass();
                } else {
                    if(!window.appState.activeClassId) {
                        window.appState.activeClassId = window.appState.classes[0].id;
                    }
                }

                renderClassSelector();
                renderAll();
            } catch (e) {
                console.error("Fetch Error:", e);
                // Jika error permission, biasanya karena Firestore Rules belum di set public/test mode
                if(e.code === 'permission-denied') {
                     Swal.fire("Akses Ditolak", "Database terkunci. Pastikan Firestore Rules dalam 'Test Mode'.", "error");
                } else {
                     Swal.fire("Error", "Gagal mengambil data kelas: " + e.message, "error");
                }
            } finally {
                showLoading(false);
            }
        }

        async function createDefaultClass() {
            const defaultClass = {
                id: 'cls_' + Date.now(),
                name: "Kelas Percobaan",
                info: {
                    school: "SMK NEGERI CONTOH",
                    mapel: "Mata Pelajaran",
                    guru: "Nama Guru, S.Pd",
                    semester: "Ganjil / 2024-2025"
                },
                students: [
                    { id: 1, nis: "101", name: "Siswa Contoh", gender: "L", absensi: Array(30).fill(""), nilai: {lm1:0,lm2:0,lm3:0,lm4:0,sts:0,sas:0} }
                ]
            };
            
            await saveClassToFirestore(defaultClass);
            window.appState.classes.push(defaultClass);
            window.appState.activeClassId = defaultClass.id;
        }

        async function saveClassToFirestore(classObj) {
            if(!currentUser) return;
            showStatus("Menyimpan...", "text-yellow-500");
            
            try {
                const docRef = doc(db, 'users', currentUser.uid, 'classes', classObj.id);
                const dataToSave = JSON.parse(JSON.stringify(classObj));
                await setDoc(docRef, dataToSave);
                showStatus("Tersimpan (Online)", "text-green-500");
            } catch (e) {
                console.error("Save Error:", e);
                showStatus("Gagal Menyimpan", "text-red-500");
            }
        }

        async function deleteClassFromFirestore(classId) {
            if(!currentUser) return;
            const docRef = doc(db, 'users', currentUser.uid, 'classes', classId);
            await deleteDoc(docRef);
        }

        // --- 4. GLOBAL FUNCTIONS ---

        window.getActiveClass = () => window.appState.classes.find(c => c.id === window.appState.activeClassId);

        window.changeClass = (classId) => {
            window.appState.activeClassId = classId;
            renderAll();
        }

        window.addNewClass = async () => {
            const { value: text } = await Swal.fire({
                input: 'text', inputLabel: 'Nama Kelas Baru', inputPlaceholder: 'Contoh: XI RPL 2', showCancelButton: true
            });
            if (text) {
                const newClass = {
                    id: 'cls_' + Date.now(),
                    name: text,
                    info: { ...window.getActiveClass().info },
                    students: []
                };
                window.appState.classes.push(newClass);
                window.appState.activeClassId = newClass.id;
                await saveClassToFirestore(newClass);
                renderClassSelector();
                renderAll();
            }
        }

        window.deleteCurrentClass = () => {
            if(window.appState.classes.length <= 1) {
                Swal.fire('Error', 'Minimal harus menyisakan satu kelas.', 'error');
                return;
            }
            const current = window.getActiveClass();
            Swal.fire({
                title: `Hapus ${current.name}?`, text: "Data akan dihapus permanen dari Database!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading(true);
                    await deleteClassFromFirestore(current.id);
                    window.appState.classes = window.appState.classes.filter(c => c.id !== window.appState.activeClassId);
                    window.appState.activeClassId = window.appState.classes[0].id;
                    renderClassSelector();
                    renderAll();
                    showLoading(false);
                }
            })
        }

        let debounceTimer;
        window.debouncedUpdateInfo = () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { window.updateClassInfo(); }, 1000);
        }

        window.updateClassInfo = () => {
            const cls = window.getActiveClass();
            cls.name = document.getElementById('in-classname').value;
            cls.info.school = document.getElementById('in-school').value;
            cls.info.mapel = document.getElementById('in-mapel').value;
            cls.info.guru = document.getElementById('in-guru').value;
            cls.info.semester = document.getElementById('in-semester').value;
            
            const selector = document.getElementById('class-selector');
            selector.options[selector.selectedIndex].text = cls.name;
            updateHeaders(cls);
            saveClassToFirestore(cls);
        }

        window.addStudent = async () => {
            const cls = window.getActiveClass();
            cls.students.push({
                id: Date.now(), nis: "", name: "Siswa Baru", gender: "",
                absensi: Array(30).fill(""), nilai: {lm1:0, lm2:0, lm3:0, lm4:0, sts:0, sas:0}
            });
            renderAll();
            await saveClassToFirestore(cls);
        }

        window.confirmDeleteStudent = (index) => {
            const cls = window.getActiveClass();
            Swal.fire({
                title: 'Hapus Siswa?', text: `Hapus "${cls.students[index].name}"?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    cls.students.splice(index, 1);
                    renderAll();
                    await saveClassToFirestore(cls);
                }
            });
        }

        let saveTimer;
        function debouncedSave(cls) {
            showStatus("Mengetik...", "text-blue-500");
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => { saveClassToFirestore(cls); }, 1500);
        }

        window.updateStudent = (index, field, value) => {
            const cls = window.getActiveClass();
            cls.students[index][field] = value;
            debouncedSave(cls); 
        }

        window.updateNilai = (index, key, value) => {
            const cls = window.getActiveClass();
            cls.students[index].nilai[key] = value;
            renderNilaiTable(cls); 
            debouncedSave(cls);
        }

        window.cycleAbsensi = (studentIndex, dateIndex) => {
            const cls = window.getActiveClass();
            const cycles = ["", "S", "I", "A", "B"]; 
            let current = cls.students[studentIndex].absensi[dateIndex] || "";
            let nextIndex = (cycles.indexOf(current) + 1) % cycles.length;
            cls.students[studentIndex].absensi[dateIndex] = cycles[nextIndex];
            renderAbsensiTable(cls);
            saveClassToFirestore(cls);
        }

        // --- EXCEL ---
        window.exportToExcel = () => {
            const cls = window.getActiveClass();
            const exportData = cls.students.map((s, i) => ({
                No: i + 1, NIS: s.nis, Nama: s.name, Gender: s.gender,
                Nilai_Akhir: calculateNA(s.nilai).na
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Siswa " + cls.name);
            XLSX.writeFile(wb, `Data_${cls.name}.xlsx`);
        }

        window.importFromExcel = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                    
                    const cls = window.getActiveClass();
                    let importedCount = 0;
                    for(let i=1; i<jsonData.length; i++) {
                        const row = jsonData[i];
                        if(!row || row.length === 0) continue;
                        const nis = row[1] || "";
                        const nama = row[2] || "";
                        if(nama) {
                            cls.students.push({
                                id: Date.now() + i, nis: nis.toString(), name: nama.toString(), gender: (row[3]||"L").toString(),
                                absensi: Array(30).fill(""), nilai: {lm1:0,lm2:0,lm3:0,lm4:0,sts:0,sas:0}
                            });
                            importedCount++;
                        }
                    }
                    renderAll();
                    await saveClassToFirestore(cls);
                    Swal.fire('Sukses', `${importedCount} siswa diimport!`, 'success');
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Gagal membaca file Excel.', 'error');
                }
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        // --- RENDER ---
        window.renderAll = () => {
            const cls = window.getActiveClass();
            if(!cls) return;
            updateHeaders(cls);
            updateInputs(cls);
            document.querySelectorAll('.print-class-name').forEach(el => el.innerText = cls.name);
            renderStudentList(cls);
            renderAbsensiTable(cls);
            renderNilaiTable(cls);
        }

        window.renderClassSelector = () => {
            const select = document.getElementById('class-selector');
            select.innerHTML = '';
            window.appState.classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.text = c.name;
                if(c.id === window.appState.activeClassId) option.selected = true;
                select.appendChild(option);
            });
        }

        function updateHeaders(cls) {
            document.getElementById('disp-school').innerText = cls.info.school;
            document.getElementById('disp-mapel').innerText = cls.info.mapel;
            document.getElementById('disp-kelas').innerText = cls.name;
            document.getElementById('disp-guru').innerText = cls.info.guru;
            document.getElementById('disp-semester').innerText = cls.info.semester;
            document.getElementById('sign-guru').innerText = cls.info.guru;
        }

        function updateInputs(cls) {
            if(document.activeElement.tagName !== 'INPUT') {
                document.getElementById('in-classname').value = cls.name;
                document.getElementById('in-school').value = cls.info.school;
                document.getElementById('in-mapel').value = cls.info.mapel;
                document.getElementById('in-guru').value = cls.info.guru;
                document.getElementById('in-semester').value = cls.info.semester;
            }
        }

        function renderStudentList(cls) {
            const tbody = document.getElementById('student-list-body');
            let html = '';
            cls.students.forEach((s, i) => {
                html += `
                <tr class="hover:bg-gray-50">
                    <td class="border p-2 text-center">${i+1}</td>
                    <td class="border p-2"><input type="text" value="${s.nis}" oninput="window.updateStudent(${i}, 'nis', this.value)" class="w-full text-center editable" placeholder="NIS"></td>
                    <td class="border p-2"><input type="text" value="${s.name}" oninput="window.updateStudent(${i}, 'name', this.value)" class="w-full font-bold editable" placeholder="Nama Siswa"></td>
                    <td class="border p-2"><input type="text" value="${s.gender}" oninput="window.updateStudent(${i}, 'gender', this.value)" class="w-full text-center editable uppercase" placeholder="L/P"></td>
                    <td class="border p-2 text-center no-print">
                        <button onclick="window.confirmDeleteStudent(${i})" class="bg-red-100 text-red-600 hover:bg-red-600 hover:text-white px-2 py-1 rounded transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
            });
            if(cls.students.length === 0) html = '<tr><td colspan="5" class="text-center p-8 text-gray-500 italic">Belum ada siswa.</td></tr>';
            tbody.innerHTML = html;
        }

        function renderAbsensiTable(cls) {
            const tbody = document.getElementById('absensi-body');
            let html = '';
            cls.students.forEach((s, i) => {
                let counts = { S:0, I:0, A:0, B:0 };
                s.absensi.forEach(x => { if(counts[x] !== undefined) counts[x]++ });
                html += `<tr><td class="border border-black p-1 text-center">${i+1}</td><td class="border border-black p-1 px-2 whitespace-nowrap">${s.name}</td>`;
                for(let d=0; d<30; d++) {
                    let val = s.absensi[d] || ".";
                    let colorClass = val === 'S' ? 'bg-yellow-200' : val === 'I' ? 'bg-blue-200' : val === 'A' ? 'bg-red-200' : val === 'B' ? 'bg-purple-300 font-bold' : '';
                    html += `<td onclick="window.cycleAbsensi(${i}, ${d})" class="border border-black p-0 text-center cursor-pointer hover:bg-gray-200 select-none ${colorClass}" style="font-size:9px; min-width: 15px;">${val}</td>`;
                }
                html += `<td class="border border-black p-1 text-center bg-yellow-50 font-bold text-xs">${counts.S||''}</td><td class="border border-black p-1 text-center bg-blue-50 font-bold text-xs">${counts.I||''}</td><td class="border border-black p-1 text-center bg-red-50 font-bold text-xs">${counts.A||''}</td><td class="border border-black p-1 text-center bg-purple-100 font-bold text-xs text-purple-900">${counts.B||''}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderNilaiTable(cls) {
            const tbody = document.getElementById('nilai-body');
            let html = '';
            cls.students.forEach((s, i) => {
                const n = s.nilai;
                const res = window.calculateNA(n);
                html += `<tr class="hover:bg-gray-50"><td class="border border-black p-1 text-center">${i+1}</td><td class="border border-black p-1 px-2 whitespace-nowrap">${s.name}</td>
                <td class="border border-black p-0"><input type="number" value="${n.lm1||''}" oninput="window.updateNilai(${i}, 'lm1', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-0"><input type="number" value="${n.lm2||''}" oninput="window.updateNilai(${i}, 'lm2', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-0"><input type="number" value="${n.lm3||''}" oninput="window.updateNilai(${i}, 'lm3', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-0"><input type="number" value="${n.lm4||''}" oninput="window.updateNilai(${i}, 'lm4', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-1 text-center bg-gray-100 text-xs font-bold">${res.avgLM > 0 ? res.avgLM.toFixed(0) : ''}</td>
                <td class="border border-black p-0"><input type="number" value="${n.sts||''}" oninput="window.updateNilai(${i}, 'sts', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-0"><input type="number" value="${n.sas||''}" oninput="window.updateNilai(${i}, 'sas', this.value)" class="w-full text-center p-1 outline-none text-xs"></td>
                <td class="border border-black p-1 text-center bg-blue-100 font-bold text-blue-900">${res.NA > 0 ? res.NA : ''}</td>
                <td class="border border-black p-1 px-2 text-center text-xs italic font-bold ${res.NA < 75 && res.NA > 0 ? 'text-red-600' : 'text-green-700'}">${res.predikat}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        window.calculateNA = (n) => {
            let lmSum = (parseFloat(n.lm1)||0) + (parseFloat(n.lm2)||0) + (parseFloat(n.lm3)||0) + (parseFloat(n.lm4)||0);
            let lmCount = 0; if(n.lm1 > 0) lmCount++; if(n.lm2 > 0) lmCount++; if(n.lm3 > 0) lmCount++; if(n.lm4 > 0) lmCount++;
            let avgLM = lmCount > 0 ? (lmSum / lmCount) : 0;
            let components = 1; let totalScore = avgLM;
            if(n.sts > 0) { totalScore += parseFloat(n.sts); components++; }
            if(n.sas > 0) { totalScore += parseFloat(n.sas); components++; }
            let NA = avgLM > 0 ? (totalScore / components).toFixed(0) : 0;
            let predikat = NA >= 90 ? "A" : NA >= 80 ? "B" : NA >= 75 ? "C" : "D";
            if(NA == 0) predikat = "-";
            return { avgLM, NA, predikat };
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function showStatus(msg, colorClass) {
            const statusEl = document.getElementById('save-status');
            statusEl.innerHTML = `<span class="status-indicator ${colorClass}"></span> ${msg}`;
            statusEl.className = "text-xs flex items-center gap-1 hidden md:flex " + colorClass;
        }

        window.switchTab = (tabId) => {
            document.getElementById('tab-data').classList.add('hidden'); document.getElementById('tab-absensi').classList.add('hidden'); document.getElementById('tab-nilai').classList.add('hidden');
            document.querySelectorAll('button[id^="btn-"]').forEach(btn => { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive', 'text-gray-300'); });
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            const activeBtn = document.getElementById('btn-' + tabId); activeBtn.classList.remove('tab-inactive', 'text-gray-300'); activeBtn.classList.add('tab-active');
        }

        window.onload = () => {
             const date = new Date();
             const options = { year: 'numeric', month: 'long', day: 'numeric' };
             const dateEl = document.getElementById('date-now');
             if(dateEl) dateEl.innerText = date.toLocaleDateString('id-ID', options);
        }
    </script>
</body>
</html>
